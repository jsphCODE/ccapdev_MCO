{{!-- Flights Management HBS Template --}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flights Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            background-color: green;
        }
        .card {
            border-radius: 30px;
        }
    </style>
</head>
<body>

    <div class="card p-4 mb-5">
        <h4 class="text-center">Add or Edit Flight</h4>
        <form id="flightForm" class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Flight Number</label>
                <input type="text" id="flightNumber" class="form-control" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Origin</label>
                <select id="origin" class="form-select" required>
                    <option value="">Select Origin</option>
                    {{#each origins}}
                        <option value="{{this}}">{{this}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Destination</label>
                <select id="destination" class="form-select" required>
                    <option value="">Select Destination</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Schedule</label>

                <select id="dayOfWeek" class="form-select" required>
                    <option value="">Select Day</option>
                    <option>Monday</option>
                    <option>Tuesday</option>
                    <option>Wednesday</option>
                    <option>Thursday</option>
                    <option>Friday</option>
                    <option>Saturday</option>
                    <option>Sunday</option>
                </select>

                <input type="time" id="departureTime" class="form-control mt-2" required>
                <input type="time" id="arrivalTime" class="form-control mt-2" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Aircraft Type</label>
                <select id="aircraft" class="form-select" required>
                    <option value="">Select Aircraft</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Seat Capacity</label>
                <input type="number" id="capacity" class="form-control" min="1" required>
            </div>

            <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-success me-2">Save Flight</button>
                <button type="reset" class="btn btn-secondary">Clear</button>
            </div>

        </form>
    </div>

    <div class="card p-4">
        <h4 class="mb-4">Flights List</h4>
        <table class="table table-bordered table-striped text-center">
            <thead class="table-light">
                <tr>
                    <th>Flight Number</th>
                    <th>Origin</th>
                    <th>Destination</th>
                    <th>Schedule</th>
                    <th>Aircraft</th>
                    <th>Capacity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="flightTable"></tbody>
        </table>
    </div>

<script>
    // âœ” Accept from Express backend
    const destinations = {{{json destinations}}};
    const aircraftByOrigin = {{{json aircraftByOrigin}}};

    $("#origin").on("change", function() {
        const origin = $(this).val();
        const destSelect = $("#destination");
        const aircraftSelect = $("#aircraft");

        destSelect.empty().append('<option value="">Select Destination</option>');
        aircraftSelect.empty().append('<option value="">Select Aircraft</option>');

        if (destinations[origin]) {
            destinations[origin].forEach(dest => {
                destSelect.append(`<option value="${dest}">${dest}</option>`);
            });
        }

        if (aircraftByOrigin[origin]) {
            aircraftByOrigin[origin].forEach(plane => {
                aircraftSelect.append(`<option value="${plane}">${plane}</option>`);
            });
        }
    });

    let flights = [];

    $("#flightForm").on("submit", function(e) {
        e.preventDefault();

        const flight = {
            number: $("#flightNumber").val(),
            origin: $("#origin").val(),
            destination: $("#destination").val(),
            schedule: $("#dayOfWeek").val() + " " +
                      $("#departureTime").val() + "-" +
                      $("#arrivalTime").val(),
            aircraft: $("#aircraft").val(),
            capacity: $("#capacity").val()
        };

        const index = flights.findIndex(f => f.number === flight.number);
        if (index >= 0) flights[index] = flight;
        else flights.push(flight);

        renderFlights();
        this.reset();
    });

    function renderFlights() {
        let rows = "";
        flights.forEach((f, i) => {
            rows += `
                <tr>
                    <td>${f.number}</td>
                    <td>${f.origin}</td>
                    <td>${f.destination}</td>
                    <td>${f.schedule}</td>
                    <td>${f.aircraft}</td>
                    <td>${f.capacity}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" onclick="editFlight(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFlight(${i})">Delete</button>
                    </td>
                </tr>`;
        });
        $("#flightTable").html(rows);
    }

    function editFlight(index) {
        const f = flights[index];

        $("#flightNumber").val(f.number);
        $("#origin").val(f.origin).trigger("change");

        setTimeout(() => {
            $("#destination").val(f.destination);
            $("#aircraft").val(f.aircraft);
        }, 100);

        $("#capacity").val(f.capacity);
    }

    function deleteFlight(index) {
        if (confirm("Delete this flight?")) {
            flights.splice(index, 1);
            renderFlights();
        }
    }
</script>

</body>
</html>
