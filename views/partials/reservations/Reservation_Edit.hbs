<h2>Edit Reservation</h2>

<form id="editReservationForm" action="/reservations/{{reservation._id}}/edit" method="POST">
  <div class="card p-3 mb-3">
    <h4>Flight</h4>
    <p>{{reservation.flight.flightNumber}} — {{reservation.flight.origin}} → {{reservation.flight.destination}}</p>
    <p>{{formatDate reservation.flight.schedule}}</p>
  </div>

  <div class="card p-3 mb-3">
    <h4>Passenger</h4>
    <p><strong>Name:</strong> {{reservation.reserveUser}}</p>
    <p><strong>Email:</strong> {{reservation.reserveEmail}}</p>
    <p><strong>Passport:</strong> {{reservation.passportNo}}</p>
  </div>

  <h4>Seat Selection</h4>
  <p>Current seat: <strong>{{reservation.seat}}</strong></p>

  <div class="mb-3">
    {{#each seatRows}}
<div class="row justify-content-center mb-2">

    <div class="col-auto">
        {{#each this.aisle1}}
        <button type="button"
            class="btn seat 
                {{#if this.isReserved}}reserved{{else}}available{{/if}}
                {{#if this.isSelected}}selected{{/if}}"
            data-seat="{{this.id}}"
            {{#if this.isReserved}}disabled{{/if}}>
            {{this.id}}
        </button>
        {{/each}}
    </div>

    <div class="col-auto">
        {{#each this.aisle2}}
        <button type="button"
            class="btn seat 
                {{#if this.isReserved}}reserved{{else}}available{{/if}}
                {{#if this.isSelected}}selected{{/if}}"
            data-seat="{{this.id}}"
            {{#if this.isReserved}}disabled{{/if}}>
            {{this.id}}
        </button>
        {{/each}}
    </div>

</div>
{{/each}}
  </div>

  <input type="hidden" id="seat" name="seat" value="{{reservation.seat}}">

  <div class="mb-3">
    <label>Meal</label>
    <select id="meal" name="meal" class="form-select">
      <option value="standard" {{#ifeq reservation.meal "standard"}}selected{{/ifeq}}>Standard</option>
      <option value="vegetarian" {{#ifeq reservation.meal "vegetarian"}}selected{{/ifeq}}>Vegetarian</option>
      <option value="kosher" {{#ifeq reservation.meal "kosher"}}selected{{/ifeq}}>Kosher</option>
      <option value="etc" {{#ifeq reservation.meal "etc"}}selected{{/ifeq}}>Other</option>
    </select>
  </div>

  <div class="mb-3">
    <label>Extra Baggage</label>
    <select id="baggage" name="baggage" class="form-select">
      <option value="none" {{#ifeq reservation.baggage "none"}}selected{{/ifeq}}>None</option>
      <option value="small" {{#ifeq reservation.baggage "small"}}selected{{/ifeq}}>Small</option>
      <option value="medium" {{#ifeq reservation.baggage "medium"}}selected{{/ifeq}}>Medium</option>
      <option value="large" {{#ifeq reservation.baggage "large"}}selected{{/ifeq}}>Large</option>
    </select>
  </div>

  <div id="summary" class="alert alert-info d-none"></div>

  <div class="text-center">
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="/reservations/my-bookings" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<script>
$(function(){
  let readyToSubmit = false;

  $(document).on("click", ".seat.available", function(){
    $(".seat").removeClass("selected");
    $(this).addClass("selected");
    $("#seat").val($(this).data("seat"));
  });

  $("#editReservationForm").on("submit", function(e){
    if (!readyToSubmit) {
      e.preventDefault();
      const meal = $("#meal").val();
      const seat = $("#seat").val();
      const baggage = $("#baggage").val();

      if (!seat) {
        $("#summary").removeClass("d-none alert-info").addClass("alert-danger").html("Select a seat first.");
        return;
      }

      let baseFare = 5000;
      let baggageFee = 0;
      switch (baggage) {
        case "small": baggageFee = 500; break;
        case "medium": baggageFee = 1000; break;
        case "large": baggageFee = 1500; break;
      }
      let mealFee = meal !== "standard" ? 300 : 0;
      const total = baseFare + baggageFee + mealFee;

      $("#summary").removeClass("d-none alert-danger").addClass("alert-info")
        .html(`<h5>Updated Summary</h5>Seat: ${seat}<br>Baggage: ${baggage}<br>Total: ₱${total.toLocaleString()}<br><small>Click Save Changes again to confirm.</small>`);

      readyToSubmit = true;
      return;
    }
    return true;
  });
});
</script>
